// Enable modal button when dropdown changes
$(".ip_dropdown").on("change", () => {
    $(".modal.show .btn").removeAttr("disabled");
});

// Handle configuration dropdown change
$(".conf_dropdown").on("change", function () {
    const $ipDropdown = $(".modal.show .ip_dropdown");
    $ipDropdown.html('<option value="none" selected disabled>Loading...</option>');

    const selectedConfig = $(this).children("option:selected").val();
    $.ajax({
        url: "/get_ping_ip",
        method: "POST",
        data: `config=${selectedConfig}`,
        success: (response) => {
            $ipDropdown.html('<option value="none" selected disabled>Choose an IP</option>');
            $ipDropdown.append(response);
        },
    });
});

// Handle ping button click
$(".send_ping").on("click", function () {
    const $this = $(this);
    $this.attr("disabled", "disabled").html("Pinging...");
    $("#ping_modal .form-control").attr("disabled", "disabled");

    const selectedIP = $(":selected", $("#ping_modal .ip_dropdown")).val();
    const pingCount = $("#ping_modal .ping_count").val();

    $.ajax({
        method: "POST",
        url: "/ping_ip",
        data: `ip=${selectedIP}&count=${pingCount}`,
        success: (response) => {
            const resultHtml = `
                <tr><th scope="row">Address</th><td>${response.address}</td></tr>
                <tr><th scope="row">Is Alive</th><td>${response.is_alive}</td></tr>
                <tr><th scope="row">Min RTT</th><td>${response.min_rtt}ms</td></tr>
                <tr><th scope="row">Average RTT</th><td>${response.avg_rtt}ms</td></tr>
                <tr><th scope="row">Max RTT</th><td>${response.max_rtt}ms</td></tr>
                <tr><th scope="row">Package Sent</th><td>${response.package_sent}</td></tr>
                <tr><th scope="row">Package Received</th><td>${response.package_received}</td></tr>
                <tr><th scope="row">Package Loss</th><td>${response.package_loss}</td></tr>
            `;
            $(".ping_result tbody").html(resultHtml);
            $this.removeAttr("disabled").html("Ping");
            $("#ping_modal .form-control").removeAttr("disabled");
        },
    });
});

// Handle traceroute button click
$(".send_traceroute").on("click", function () {
    const $this = $(this);
    $this.attr("disabled", "disabled").html("Tracing...");
    $("#traceroute_modal .form-control").attr("disabled", "disabled");

    const selectedIP = $(":selected", $("#traceroute_modal .ip_dropdown")).val();

    $.ajax({
        url: "/traceroute_ip",
        method: "POST",
        data: `ip=${selectedIP}`,
        success: (response) => {
            const resultHtml = response.map(
                (hop) => `
                    <tr>
                        <th scope="row">${hop.hop}</th>
                        <td>${hop.ip}</td>
                        <td>${hop.avg_rtt}</td>
                        <td>${hop.min_rtt}</td>
                        <td>${hop.max_rtt}</td>
                    </tr>
                `
            ).join("");
            $(".traceroute_result tbody").html(resultHtml);
            $this.removeAttr("disabled").html("Traceroute");
            $("#traceroute_modal .form-control").removeAttr("disabled");
        },
    });
});